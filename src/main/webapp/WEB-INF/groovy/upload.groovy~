import util.*

import com.google.appengine.api.blobstore.BlobKey 
import com.google.appengine.api.blobstore.BlobInfo

def blobs = blobstore.getUploadedBlobs(request)
def blob = blobs["pdfFile"]


//println "File name: ${blob.filename} <br/>"
//println "Content type: ${blob.contentType}<br/>"
//println "Creation date: ${blob.creation}<br/>"
//println "Size: ${blob.size}<br/>"

blob.withStream { inputStream -> 
	def pdf = new PDF()
	pdf.open(inputStream) 
	def fields = pdf.listFormFields()
	def pdfStamper = files.createNewBlobFile("application/pdf", "certificadoSaida.pdf")
	pdfStamper.withOutputStream(locked: true, finalize: true) { outputStream ->
		pdf.preparePdfStamper(outputStream)
		pdf.changeFieldValue("NOME_INSTITUICAO",'TAKOAKARANAKOMBI')
		pdf.closeAll()
	}
	BlobInfo inf = pdfStamper.blobKey.info
	response.setHeader("Content-Type", "application/pdf");
	response.setHeader("Content-Length", String.valueOf(inf.size));
	response.setHeader("Content-Disposition", "attachment;filename=\"" + 'certificadout.pdf' + "\"");
	blobstore.serve(pdfStamper.blobKey, response)
}

//	println "fields $fields<br/>"
/*
blobstore.each { 
	BlobInfo i -> println "${i.blobKey} -> $i.creation - $i.filename - $i.size - $i.contentType <br/>"
	BlobKey blobx = i.blobKey
}
*/


/*
  response.setHeader("Content-Type", "application/pdf");
  response.setHeader("Content-Length", String.valueOf(blob.size));
  response.setHeader("Content-Disposition", "attachment;filename=\"" + 'certificadout.pdf' + "\"");
	blob.withReader { out << it.text } 
*/
	/*
	def key = pdfStamper.getFullPath()
	BlobInfo inf = pdfStamper.blobKey.info
	//println "BK ${pdfStamper.blobKey} ${inf.size} NEW KEY: ${key} ${pdfStamper.hasFinalizedName()}"
	*/

/*
response.setContentType("application/pdf"); 
response.setHeader("Content-Disposition","attachment;filename=Informe.pdf"); 
ouputStream = response.getOutputStream(); 
ouputStream.write(pdf); 
ouputStream.flush(); 
ouputStream.close(); 
- See more at: http://www.icesoft.org/JForum/posts/list/10303.page#sthash.7kaxzorD.dpuf
*/

//}	

/*
response.status = 302
 
if (blob) {
redirect "/success?key=${blob.keyString}"
} else {
redirect "/failure"
}
*/
